<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Advanced Interactive Quiz App - Fixed Dark Mode & Difficulty</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
    :root {
      --blue: #007bff;
      --blue-dark: #0056b3;
      --green: #28a745;
      --yellow: #ffc107;
      --red: #dc3545;
      --gray-light: #e9ecef;
      --bg-light: #f9f9f9;
      --bg-dark: #121212;
      --text-light: #f0f0f0;
      --text-dark: #212529;
      --font-sans: 'Poppins', sans-serif;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0; padding: 20px;
      background-color: var(--bg-light);
      color: var(--text-dark);
      font-family: var(--font-sans);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      transition: background-color 0.5s, color 0.5s;
    }
    body.dark-mode {
      background-color: var(--bg-dark);
      color: var(--text-light);
      
    }
    #app {
      background: white;
      max-width: 800px;
      width: 100%;
      border-radius: 16px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.15);
      padding: 40px 50px;
      position: relative;
      transition: background-color 0.5s, color 0.5s;
    }
    body.dark-mode #app {
      background: #222;
      box-shadow: 0 12px 40px rgba(255,255,255,0.1);
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 700;
    }
    h1 {
      font-size: 2.75rem;
    }
    h2 {
      font-size: 2.2rem;
    }
    button, .btn {
      background-color: var(--blue);
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      display: block;
      font-size: 1.15rem;
      font-weight: 600;
      padding: 15px 30px;
      margin: 18px auto;
      min-width: 180px;
      transition: background-color 0.25s ease, transform 0.15s ease;
      box-shadow: 0 4px 8px rgba(0,123,255,0.5);
      user-select: none;
    }
    button:hover, .btn:hover {
      background-color: var(--blue-dark);
      transform: scale(1.05);
      box-shadow: 0 8px 18px rgba(0,123,255,0.7);
    }
    button:focus, .btn:focus {
      outline: 3px solid var(--blue-dark);
      outline-offset: 3px;
    }
    button:disabled, .btn:disabled {
      background-color: #888;
      cursor: default;
      transform: none;
      box-shadow: none;
    }
    .hide { display: none !important; }
    #question {
      font-size: 1.7rem;
      font-weight: 600;
      margin-bottom: 30px;
      min-height: 130px;
      user-select: none;
    }
    #question img, #question iframe {
      max-width: 100%;
      border-radius: 15px;
      margin-top: 15px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
    }
    #answers {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 25px;
    }
    @media (max-width: 620px) {
      #answers {
        grid-template-columns: 1fr;
      }
    }
    .answer-btn {
      background-color: var(--gray-light);
      color: var(--text-dark);
      padding: 20px;
      font-size: 1.2rem;
      border-radius: 20px;
      font-weight: 700;
      box-shadow: 0 9px 20px rgba(0,0,0,0.1);
      border: 4px solid transparent;
      user-select: none;
      transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }
    body.dark-mode .answer-btn {
      background-color: #333;
      color: var(--text-light);
      box-shadow: 0 10px 26px rgba(255,255,255,0.06);
    }
    .answer-btn:hover:not(:disabled) {
      background-color: var(--blue);
      color: white;
      box-shadow: 0 16px 36px rgba(0,123,255,0.45);
      transform: translateY(-6px);
    }
    .answer-btn:focus-visible {
      outline: 3px solid var(--blue-dark);
      outline-offset: 4px;
    }
    .answer-btn.disabled {
      cursor: default;
      pointer-events: none;
      opacity: 0.85;
      box-shadow: none;
      transform: none;
    }
    .answer-btn.correct {
      background-color: var(--green);
      color: white;
      border-color: #1e7e34;
      box-shadow: 0 14px 32px rgba(40,167,69,0.75);
      cursor: default;
      transform: none;
    }
    .answer-btn.wrong {
      background-color: var(--red);
      color: white;
      border-color: #bd2130;
      box-shadow: 0 14px 32px rgba(220,53,69,0.75);
      cursor: default;
      transform: none;
    }
    #explanation {
      font-style: italic;
      font-size: 1.1rem;
      color: #555;
      margin-bottom: 20px;
      min-height: 50px;
      user-select: none;
    }
    body.dark-mode #explanation {
      color: #ccc;
    }
    #fun-fact {
      font-size: 1.1rem;
      color: var(--yellow);
      font-weight: 600;
      margin-bottom: 35px;
      user-select: none;
      text-align: center;
    }
    #progress-container {
      height: 20px;
      width: 100%;
      background: rgba(255,255,255,0.2);
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 35px;
      box-shadow: inset 0 1px 3px rgba(255,255,255,0.7);
    }
    #progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #94d058, #4ac26b);
      transition: width 0.45s ease;
      will-change: width;
    }
    #timer {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 14px;
      font-weight: 800;
      font-size: 1.5rem;
      margin-bottom: 25px;
      color: var(--yellow);
      user-select: none;
    }
    #timer svg {
      width: 48px;
      height: 48px;
      transform: rotate(-90deg);
      filter: drop-shadow(0 0 2px #ffde3aaa);
    }
    #timer circle.track {
      stroke: rgba(255, 255, 255, 0.25);
      stroke-width: 6;
    }
    #timer circle.progress {
      stroke: var(--yellow);
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.35s ease;
    }
    #timer.warning {
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    #results-container, #review-container {
      text-align: center;
      user-select: none;
    }
    #score {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 30px;
      color: var(--green);
      text-shadow: 0 0 6px #2ecc40aa;
    }
    #review-list {
      text-align: left;
      max-height: 450px;
      overflow-y: auto;
      margin-bottom: 30px;
      padding: 0 25px;
    }
    #review-list li {
      margin-bottom: 25px;
      font-size: 1.15rem;
      border-left: 5px solid var(--blue);
      padding-left: 18px;
      line-height: 1.6;
      color: var(--text-dark);
    }
    body.dark-mode #review-list li {
      color: var(--text-light);
    }
    #review-list .correct-answer {
      color: var(--green);
      font-weight: 700;
    }
    #review-list .wrong-answer {
      color: var(--red);
      font-weight: 700;
    }
    #category-selector {
      max-width: 700px;
      background: rgba(255, 255, 255, 0.15);
      padding: 35px 45px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      margin: auto;
      user-select: none;
    }
    body.dark-mode #category-selector {
      background: rgba(20, 20, 20, 0.5);
    }
    #category-selector h1 {
      margin-bottom: 40px;
      color: var(--yellow);
      text-shadow: 0 0 15px #ffde3aaa;
    }
    #category-selector button {
      margin: 15px 12px;
      min-width: 180px;
    }
    #difficulty-selector {
      text-align: center;
      margin: 25px 0 40px;
    }
    #difficulty-selector label {
      font-weight: 700;
      margin: 0 12px 0 0;
      font-size: 1.1rem;
    }
    #difficulty-selector select {
      font-size: 1.05rem;
      padding: 6px 12px;
      border-radius: 8px;
      border: 2px solid var(--blue);
      color: var(--text-dark);
      font-weight: 600;
      transition: border-color 0.3s;
    }
    #difficulty-selector select:hover,
    #difficulty-selector select:focus {
      border-color: var(--blue-dark);
      outline: none;
    }
    .dark-mode-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      cursor: pointer;
      font-weight: 600;
      user-select: none;
      display: flex;
      align-items: center;
      font-size: 1rem;
      color: var(--yellow);
      filter: drop-shadow(0 0 3px #ffd700bb);
      transition: color 0.3s ease;
      z-index: 1100;
    }
    body.dark-mode .dark-mode-toggle {
      color: #ffdd57;
    }
    .dark-mode-toggle input[type="checkbox"] {
      width: 50px;
      height: 27px;
      position: relative;
      appearance: none;
      background: #c6c6c6;
      outline: none;
      border-radius: 27px;
      box-shadow: inset 0 0 7px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: background 0.3s ease;
      margin-left: 14px;
    }
    .dark-mode-toggle input[type="checkbox"]:checked {
      background: var(--yellow);
    }
    .dark-mode-toggle input[type="checkbox"]::before {
      content: "";
      position: absolute;
      width: 23px;
      height: 23px;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: 0.3s;
    }
    .dark-mode-toggle input[type="checkbox"]:checked::before {
      left: 25px;
    }

  </style>
</head>
<body>
  <label class="dark-mode-toggle" aria-label="Toggle dark mode" title="Toggle dark mode">
    Dark Mode
    <input type="checkbox" id="darkModeToggle" />
  </label>

  <div id="app" role="main" aria-label="Advanced quiz application with multiple categories and features">
    <div id="category-selector">
      <h1>Select Quiz Category</h1>
      <button class="btn" data-category="general">General Knowledge</button>
      <button class="btn" data-category="science">Science</button>
      <button class="btn" data-category="history">History</button>
      <button class="btn" data-category="sports">Sports</button>
      <button class="btn" data-category="movies">Movies</button>
      <button class="btn" data-category="geography">Geography</button>
      <button class="btn" data-category="literature">Literature</button>

      <div id="difficulty-selector" aria-label="Select difficulty level">
        <label for="difficulty">Difficulty:</label>
        <select id="difficulty" aria-controls="category-selector">
          <option value="all">All Levels</option>
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
    </div>

    <div id="quiz-container" class="hide" aria-live="polite" aria-atomic="true">
      <div id="timer" aria-live="polite" aria-atomic="true" aria-label="Time Remaining">
        <svg viewBox="0 0 36 36" aria-hidden="true">
          <circle class="track" cx="18" cy="18" r="16"></circle>
          <circle class="progress" cx="18" cy="18" r="16" stroke-dasharray="100" stroke-dashoffset="0"></circle>
        </svg>
        <span id="timer-text"></span>
      </div>

      <div id="progress-container" aria-hidden="true">
        <div id="progress-bar"></div>
      </div>

      <div id="question" tabindex="0" class="fade-in"></div>
      <div id="answers" class="fade-in"></div>
      <div id="explanation" aria-live="polite" aria-atomic="true" class="fade-in"></div>
      <div id="fun-fact"></div>
      <button id="next-btn" class="btn hide" aria-label="Next question">Next</button>
    </div>

    <div id="results-container" class="hide" aria-live="polite" aria-atomic="true">
      <h2>Quiz Completed!</h2>
      <div id="score"></div>
      <button id="review-btn" class="btn">Review Answers</button>
      <button id="restart-btn" class="btn">Restart Quiz</button>
    </div>

    <div id="review-container" class="hide" tabindex="0">
      <h2>Your Answers Review</h2>
      <ul id="review-list" role="list"></ul>
      <button id="close-review-btn" class="btn">Close Review</button>
    </div>
  </div>

  <audio id="snd-correct" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="snd-wrong" src="https://actions.google.com/sounds/v1/cartoon/boing.ogg"></audio>
  <audio id="snd-beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
  const quizData = {
    general:[
      {type:"multiple",difficulty:"easy",question:"What is the capital city of Spain?",
       answers:[
         {text:"Barcelona",correct:false},
         {text:"Valencia",correct:false},
         {text:"Madrid",correct:true},
         {text:"Seville",correct:false}],
       explanation:"Madrid is the capital and largest city of Spain.",
       funFact:"Madrid has over 3 million inhabitants."},
      {type:"image",difficulty:"medium",question:"Identify this landmark:",
       imageUrl:"https://upload.wikimedia.org/wikipedia/commons/a/af/Taj_Mahal_in_March_2004.jpg",
       answers:[
         {text:"Taj Mahal",correct:true},
         {text:"Hagia Sophia",correct:false},
         {text:"Colosseum",correct:false}],
       explanation:"The Taj Mahal is a UNESCO World Heritage site in India.",
       funFact:"The Taj Mahal was built over 20 years starting in 1632."},
      {type:"truefalse",difficulty:"hard",question:"The Great Wall of China is visible from the Moon.",
       answers:[
         {text:"True",correct:false},
         {text:"False",correct:true}],
       explanation:"The Great Wall cannot be seen from the Moon with the naked eye.",
       funFact:"The Wall is over 13,000 miles long."}
    ],
    science:[
      {type:"multiple",difficulty:"easy",question:"What is the chemical symbol for water?",
       answers:[
         {text:"H20",correct:false},
         {text:"HO",correct:false},
         {text:"H₂O",correct:true},
         {text:"O2",correct:false}],
       explanation:"H₂O represents two hydrogen atoms and one oxygen atom making water.",
       funFact:"Water covers about 71% of Earth's surface."},
       
      {type: "multiple",
      difficulty: "medium",
      question: "Which physicist formulated the uncertainty principle?",
      answers: [
        { text: "Albert Einstein", correct: false },
        { text: "Werner Heisenberg", correct: true },
        { text: "Niels Bohr", correct: false },
        { text: "Erwin Schrödinger", correct: false }
      ],
      explanation: "Werner Heisenberg introduced the uncertainty principle in quantum mechanics.",
      funFact: "It states that position and momentum cannot both be precisely known simultaneously."},
    
      
       {type:"multiple",difficulty:"hard",question:"How many bones does an adult human have?",
       answers:[
        { text: "Proteins", correct: false },
        { text: "RNA", correct: true },
        { text: "DNA", correct: false },
        { text: "Lipids", correct: false } ],
       explanation:"Many viruses use RNA as their genetic material.",
       funFact:"Influenza and HIV are examples of RNA viruses."}
       
    ],
    history:[
      {type:"multiple",difficulty:"easy",question:"Who was the first president of the United States?",
       answers:[
         {text:"Thomas Jefferson",correct:false},
         {text:"George Washington",correct:true},
         {text:"Abraham Lincoln",correct:false},
         {text:"John Adams",correct:false}],
       explanation:"George Washington served from 1789 to 1797.",
       funFact:"Washington only served two terms before retiring."},
      {type:"multiple",difficulty:"medium",question:"In which year did World War II end?",
       answers:[
         {text:"1945",correct:true},
         {text:"1939",correct:false},
         {text:"1918",correct:false},
         {text:"1950",correct:false}],
       explanation:"World War II ended with the Allies' victory in 1945.",
       funFact:"It involved over 30 countries worldwide."},
       {
      type: "multiple",
      difficulty: "hard",
      question: "Which treaty ended the Thirty Years' War in 1648?",
      answers: [
        { text: "Treaty of Versailles", correct: false },
        { text: "Peace of Westphalia", correct: true },
        { text: "Treaty of Utrecht", correct: false },
        { text: "Treaty of Paris", correct: false }
      ],
      explanation: "The Peace of Westphalia treaties ended the Thirty Years' War.",
      funFact: "It established the concept of state sovereignty in international law."
    },
    ],
    sports:[
      {type:"multiple",difficulty:"easy",question:"Which country won the FIFA World Cup in 2018?",
       answers:[
         {text:"Brazil",correct:false},
         {text:"France",correct:true},
         {text:"Germany",correct:false},
         {text:"Argentina",correct:false}],
       explanation:"France won the 2018 World Cup in Russia.",
       funFact:"It was France's second World Cup win."},
      {type:"truefalse",difficulty:"medium",question:"Basketball was invented in Canada.",
       answers:[
         {text:"True",correct:false},
         {text:"False",correct:true}],
       explanation:"Basketball was invented in Massachusetts, USA.",
       funFact:"James Naismith invented basketball in 1891."},
         {
      type: "multiple",
      difficulty: "hard",
      question: "Who holds the record for the most goals scored in a single FIFA World Cup?",
      answers: [
        { text: "Pelé", correct: false },
        { text: "Just Fontaine", correct: true },
        { text: "Miroslav Klose", correct: false },
        { text: "Gerd Müller", correct: false }
      ],
      explanation: "Just Fontaine scored 13 goals in the 1958 World Cup.",
      funFact: "Miroslav Klose holds the record for most goals overall in World Cup history."
    },
    ],
    movies:[
      {type:"multiple",difficulty:"easy",question:"Which actor played Jack in 'Titanic'?",
       answers:[
         {text:"Brad Pitt",correct:false},
         {text:"Leonardo DiCaprio",correct:true},
         {text:"Tom Cruise",correct:false},
         {text:"Johnny Depp",correct:false}],
       explanation:"Leonardo DiCaprio starred as Jack Dawson.",
       funFact:"Titanic won 11 Academy Awards."},
      {type:"multiple",difficulty:"medium",question:"Which movie features this quote: 'May the Force be with you'?",
       answers:[
         {text:"Star Wars",correct:true},
         {text:"Lord of the Rings",correct:false},
         {text:"Harry Potter",correct:false},
         {text:"Alien",correct:false}],
       explanation:"This famous quote is from the Star Wars franchise.",
       funFact:"First used in Star Wars: Episode IV (1977)."},
      {type:"video",difficulty:"hard",question:"Watch this clip and name the movie:",
       videoUrl:"https://www.youtube.com/embed/TcMBFSGVi1c?controls=0",
       answers:[
         {text:"The Avengers",correct:true},
         {text:"Justice League",correct:false},
         {text:"Guardians of the Galaxy",correct:false},
         {text:"X-Men",correct:false}],
       explanation:"This epic trailer is from The Avengers (2012).",
       funFact:"The Avengers was the first major MCU crossover film."}
    ],
    geography:[
      {type:"image",difficulty:"easy",question:"Identify this country from the map:",
       imageUrl:"https://upload.wikimedia.org/wikipedia/commons/8/85/Map_of_Italy.svg",
       answers:[
         {text:"Italy",correct:true},
         {text:"Spain",correct:false},
         {text:"Greece",correct:false},
         {text:"Portugal",correct:false}],
       explanation:"This is the map of Italy shaped like a boot.",
       funFact:"Italy has the world's largest number of UNESCO World Heritage sites."},
      {type:"image",difficulty:"medium",question:"Name this world famous mountain:",
       imageUrl:"https://upload.wikimedia.org/wikipedia/commons/3/35/Mt._Everest_as_seen_from_Drukair2_PLW_edit.jpg",
       answers:[
         {text:"Mount Everest",correct:true},
         {text:"K2",correct:false},
         {text:"Kangchenjunga",correct:false},
         {text:"Lhotse",correct:false}],
       explanation:"Mount Everest is Earth's highest peak.",
       funFact:"Its peak is 8,848 meters above sea level."},
       {
      type: "image",
      difficulty: "hard",
      question: "Identify this country from the map:",
      imageUrl: "https://upload.wikimedia.org/wikipedia/commons/1/17/New_Zealand_on_the_globe_%28New_Zealand_centered%29.svg",
      answers: [
        { text: "Australia", correct: false },
        { text: "New Zealand", correct: true },
        { text: "Fiji", correct: false },
        { text: "Papua New Guinea", correct: false }
      ],
      explanation: "This is the map of New Zealand.",
      funFact: "New Zealand is known for its diverse geography and indigenous Maori culture."
    },
    ],
    literature:[
      {type:"multiple",difficulty:"easy",question:"Who wrote 'Romeo and Juliet'?",
       answers:[
         {text:"William Shakespeare",correct:true},
         {text:"Mark Twain",correct:false},
         {text:"Charles Dickens",correct:false},
         {text:"Jane Austen",correct:false}],
       explanation:"Shakespeare is the author of 'Romeo and Juliet'.",
       funFact:"Written in the 1590s, it’s one of Shakespeare’s most famous plays."},
      {type:"multiple",difficulty:"medium",question:"The quote 'It was the best of times, it was the worst of times' is from which book?",
       answers:[
         {text:"Great Expectations",correct:false},
         {text:"A Tale of Two Cities",correct:true},
         {text:"Oliver Twist",correct:false},
         {text:"David Copperfield",correct:false}],
       explanation:"This is the opening line of 'A Tale of Two Cities' by Charles Dickens.",
       funFact:"The novel is set in London and Paris before and during the French Revolution."},
        {
      type: "multiple",
      difficulty: "hard",
      question: "Who is the author of the novel '1984'?",
      answers: [
        { text: "George Orwell", correct: true },
        { text: "Aldous Huxley", correct: false },
        { text: "Ray Bradbury", correct: false },
        { text: "Philip K. Dick", correct: false }
      ],
      explanation: "'1984' is a dystopian novel by George Orwell.",
      funFact: "Published in 1949, it introduced concepts like 'Big Brother' and 'thoughtcrime'."
    },
    ]
  };

  // Elements 
  const categorySelector = document.getElementById("category-selector");
  const difficultySelector = document.getElementById("difficulty");
  const quizContainer = document.getElementById("quiz-container");
  const timerElement = document.getElementById("timer");
  const timerText = document.getElementById("timer-text");
  const progressBar = document.getElementById("progress-bar");
  const questionElement = document.getElementById("question");
  const answersContainer = document.getElementById("answers");
  const explanationElement = document.getElementById("explanation");
  const funFactElement = document.getElementById("fun-fact");
  const nextButton = document.getElementById("next-btn");
  const resultsContainer = document.getElementById("results-container");
  const scoreElement = document.getElementById("score");
  const reviewButton = document.getElementById("review-btn");
  const restartButton = document.getElementById("restart-btn");
  const reviewContainer = document.getElementById("review-container");
  const reviewList = document.getElementById("review-list");
  const closeReviewButton = document.getElementById("close-review-btn");
  const darkModeToggle = document.getElementById("darkModeToggle");
  const progressCircle = timerElement.querySelector('.progress');
  const correctSound = document.getElementById('snd-correct');
  const wrongSound = document.getElementById('snd-wrong');
  const beepSound = document.getElementById('snd-beep');

  const radius = 16;
  const circumference = 2 * Math.PI * radius;

  let currentCategory = null;
  let currentDifficulty = 'all';
  let currentQuestions = [];
  let currentIndex = 0;
  let score = 0;
  let timer;
  const questionTime = 15;
  let timeLeft = questionTime;
  let userAnswers = [];

  progressCircle.style.strokeDasharray = circumference;
  progressCircle.style.strokeDashoffset = 0;

  categorySelector.addEventListener('click', e => {
    if(e.target.tagName === 'BUTTON') {
      currentCategory = e.target.dataset.category;
      currentDifficulty = difficultySelector.value;
      startQuiz();
    }
  });
  difficultySelector.addEventListener('change', e => {
    currentDifficulty = e.target.value;
  });

  nextButton.addEventListener('click', () => {
    currentIndex++;
    if(currentIndex < currentQuestions.length) {
      showQuestion();
    } else {
      showResults();
    }
  });
  reviewButton.addEventListener('click', showReview);
  restartButton.addEventListener('click', resetApp);
  closeReviewButton.addEventListener('click', () => {
    reviewContainer.classList.add('hide');
    resultsContainer.classList.remove('hide');
    reviewList.innerHTML = '';
  });
  darkModeToggle.addEventListener('change', () => {
    document.body.classList.toggle('dark-mode', darkModeToggle.checked);
  });

  function startQuiz() {
    categorySelector.classList.add('hide');
    quizContainer.classList.remove('hide');
    resultsContainer.classList.add('hide');
    reviewContainer.classList.add('hide');
    score = 0;
    currentIndex = 0;
    userAnswers = [];
    if(currentDifficulty === 'all') {
      currentQuestions = quizData[currentCategory].slice();
    } else {
      currentQuestions = quizData[currentCategory].filter(q => q.difficulty === currentDifficulty);
    }
    currentQuestions = shuffleArray(currentQuestions).slice(0, 20);
    progressBar.style.width = '0%';
    showQuestion();
  }

  function showQuestion() {
    resetState();
    const q = currentQuestions[currentIndex];
    let qHtml = `Q${currentIndex+1}. ${q.question}`;
    if(q.type === 'image' && q.imageUrl) {
      qHtml += `<br><img src="${q.imageUrl}" alt="Question image" loading="lazy"/>`;
    } else if(q.type === 'video' && q.videoUrl) {
      qHtml += `<br><iframe width="100%" height="300" src="${q.videoUrl}" frameborder="0" allowfullscreen></iframe>`;
    }
    questionElement.innerHTML = qHtml;

    explanationElement.textContent = '';
    funFactElement.textContent = '';

    updateProgressBar();
    timeLeft = questionTime;
    timerText.textContent = timeLeft + 's';
    setProgressCircle(0);
    timerElement.classList.remove('warning');

    q.answers.forEach(ans => {
      const btn = document.createElement('button');
      btn.className = 'answer-btn';
      btn.textContent = ans.text;
      btn.setAttribute('data-correct', ans.correct);
      btn.setAttribute('aria-pressed', 'false');
      btn.addEventListener('click', () => selectAnswer(btn));
      answersContainer.appendChild(btn);
    });

    startTimer();
  }

  function resetState() {
    clearInterval(timer);
    nextButton.classList.add('hide');
    explanationElement.textContent = '';
    funFactElement.textContent = '';
    while(answersContainer.firstChild) answersContainer.removeChild(answersContainer.firstChild);
  }

  function startTimer() {
    clearInterval(timer);
    timer = setInterval(() => {
      timeLeft--;
      timerText.textContent = timeLeft + 's';
      setProgressCircle((questionTime - timeLeft) / questionTime);
      if(timeLeft <= 5 && timeLeft > 0) {
        timerElement.classList.add('warning');
        beepSound.play().catch(() => {});
      }
      if(timeLeft <= 0) {
        clearInterval(timer);
        timerElement.classList.remove('warning');
        revealCorrectAnswer(null);
      }
    }, 1000);
  }

  function setProgressCircle(percent) {
    const offset = circumference - percent * circumference;
    progressCircle.style.strokeDashoffset = offset;
  }

  function selectAnswer(selectedBtn) {
    clearInterval(timer);
    timerElement.classList.remove('warning');

    if(selectedBtn.classList.contains('disabled')) return;

    const correct = selectedBtn.getAttribute('data-correct') === 'true';
    revealCorrectAnswer(selectedBtn);

    if(correct) {
      correctSound.play().catch(() => {});
    } else {
      wrongSound.play().catch(() => {});
    }

    const currentQ = currentQuestions[currentIndex];
    userAnswers.push({
      question: currentQ.question,
      selected: selectedBtn.textContent,
      correctAnswer: currentQ.answers.find(a => a.correct).text,
      explanation: currentQ.explanation,
      funFact: currentQ.funFact || '',
      isCorrect: correct
    });

    if(correct) score++;
    nextButton.classList.remove('hide');
  }

  function revealCorrectAnswer(selectedBtn) {
    const buttons = answersContainer.querySelectorAll('button');
    buttons.forEach(btn => {
      const isCorrect = btn.getAttribute('data-correct') === 'true';
      btn.classList.add('disabled');
      if(isCorrect) btn.classList.add('correct');
    });
    if(selectedBtn && selectedBtn.getAttribute('data-correct') !== 'true') {
      selectedBtn.classList.add('wrong');
    }

    const curQ = currentQuestions[currentIndex];
    explanationElement.textContent = curQ.explanation || '';
    funFactElement.textContent = curQ.funFact ? `Fun Fact: ${curQ.funFact}` : '';
  }

  function updateProgressBar() {
    const percent = ((currentIndex) / currentQuestions.length) * 100;
    progressBar.style.width = `${percent}%`;
    if(percent > 75) {
      progressBar.style.background = "linear-gradient(90deg, #4ac26b, #007bff)";
    } else if(percent > 50) {
      progressBar.style.background = "linear-gradient(90deg, #ffc107, #007bff)";
    } else {
      progressBar.style.background = "linear-gradient(90deg, #dc3545, #007bff)";
    }
  }

  function showResults() {
    quizContainer.classList.add('hide');
    resultsContainer.classList.remove('hide');
    progressBar.style.width = '100%';
    scoreElement.textContent = `You scored ${score} out of ${currentQuestions.length}`;
    saveScoreToLocalStorage();
  }

  function showReview() {
    resultsContainer.classList.add('hide');
    reviewContainer.classList.remove('hide');
    reviewList.innerHTML = '';

    userAnswers.forEach((item, idx) => {
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>Q${idx+1}:</strong> ${item.question}<br>
        <strong>Your answer:</strong> <span class="${item.isCorrect ? 'correct-answer' : 'wrong-answer'}">${item.selected} ${item.isCorrect ? '✅' : '❌'}</span><br>
        <strong>Correct answer:</strong> <span class="correct-answer">${item.correctAnswer}</span><br>
        <em>${item.explanation}</em><br>
        ${item.funFact ? `<small><em>Fun Fact:</em> ${item.funFact}</small>` : ''}
      `;
      reviewList.appendChild(li);
    });
  }

  function saveScoreToLocalStorage() {
    const storedScores = JSON.parse(localStorage.getItem('quizScores')) || {};
    storedScores[currentCategory] = score;
    localStorage.setItem('quizScores', JSON.stringify(storedScores));
  }

  function resetApp() {
    resultsContainer.classList.add('hide');
    reviewContainer.classList.add('hide');
    quizContainer.classList.add('hide');
    categorySelector.classList.remove('hide');
    currentCategory = null;
    currentQuestions = [];
    currentIndex = 0;
    score = 0;
    userAnswers = [];
    clearInterval(timer);
    progressBar.style.width = '0%';
    setProgressCircle(0);
    timerText.textContent = '';
    darkModeToggle.checked = false;
    document.body.classList.remove('dark-mode');
  }

  function shuffleArray(arr) {
    const a = arr.slice();
    for(let i = a.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }
</script>
</body>
</html>
